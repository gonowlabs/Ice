require 'fileutils'
module LessForRails
  HEADER = %{/*
 This file was auto generated by Less (http://lesscss.org), using
 the less-for-rails plugin (http://github.com/augustl/less-for-rails).
 
 To change the contents of this file, edit %s.less instead.
*/

}
  STYLESHEETS_PATH = "#{Rails.root}/public/stylesheets"
  FileUtils.mkdir_p(STYLESHEETS_PATH)

  extend self

  # Add aditional paths where the plugin should be looking for .less files
  # with `LessForRails.paths << "my/path/here"`.
  def paths
    @paths ||= [STYLESHEETS_PATH]
  end

  # Converts all *.less files in +paths+ to STYLESHEETS_PATH/[filename].css.
  #
  # Options:
  #  compress - Remove all newlines? `true` or `false`.
  def run(options = {})
    paths.map {|path| Dir["#{path}/*.less"]}.flatten.each {|less_source|
      destination_filename = "#{File.basename(less_source, File.extname(less_source))}.css"
      destination = "#{STYLESHEETS_PATH}/#{destination_filename}"
      
      if !File.exists?(destination) || File.stat(less_source).mtime > File.stat(destination).mtime
        engine = Less::Engine.new(File.read(less_source))
        css = Less.version > "1.0" ? engine.to_css : engine.to_css(:desc)
        css.delete!("\n") if options[:compress]
      
        File.open(destination, "w") {|file|
          file.write HEADER % [destination_filename] if Rails.env == "development"
          file.write css
        }
      end
    }
  end
end